<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta
      charset="UTF-8"
      name="viewport"
      content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"
    />
    <title>schemius</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.39.3/js/jquery.terminal.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.39.3/css/jquery.terminal.min.css"
    />
    <style>
      @import url("https://cdn.jsdelivr.net/npm/@xz/fonts@1/serve/cascadia-code.css");
      @import url("https://cdn.jsdelivr.net/npm/source-code-pro@2.38.0/source-code-pro.min.css");
      @import url("https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.min.css");
      @import url("https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono.min.css");

      .terminal,
      .terminal-mobile {
        --color: #eadcb4;
        --background: #32302f;
        --link-color: #689d6a;
      }

      .terminal {
        --size: 1.3;
      }

      .terminal-mobile {
        --size: 0.5;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import init, { evaluate } from "./pkg/schemius_web.js";

      const fonts = [
        "Source Code Pro",
        "Cascadia Code",
        "Fira Code",
        "JetBrains Mono",
        "Consolas",
        "monospace"
      ];
      const localFont = localStorage.getItem("font");
      const defaultFont = localFont ?? fonts[0];

      function getFont() {
        return document.documentElement.style.getPropertyValue("--font");
      }

      function setFont(font) {
        document.documentElement.style.setProperty("--font", font);
        localStorage.setItem("font", font);
      }

      async function switchFont() {
        let currentFont = getFont();
        let keepSearching = true;
        let nVisited = 0;

        do {
          currentFont = fonts[(fonts.indexOf(currentFont) + 1) % fonts.length];
          let fontFaces = await document.fonts.load(`12pt ${currentFont}`);
          keepSearching = fontFaces.length === 0 && currentFont !== "monospace";
        } while (keepSearching && nVisited++ < fonts.length);

        console.log("Setting font to", currentFont);
        setFont(currentFont);
      }

      [
        "compositionstart",
        "compositionupdate",
        "compositionend",
        "input",
      ].forEach((event) => {
        window.addEventListener(
          event,
          (e) => {
            console.log(event, e);
          },
          true
        );
      });

      const welcomeMessage = `
    ███████╗ ██████╗██╗  ██╗███████╗███╗   ███╗██╗██╗   ██╗███████╗
    ██╔════╝██╔════╝██║  ██║██╔════╝████╗ ████║██║██║   ██║██╔════╝
    ███████╗██║     ███████║█████╗  ██╔████╔██║██║██║   ██║███████╗
    ╚════██║██║     ██╔══██║██╔══╝  ██║╚██╔╝██║██║██║   ██║╚════██║
    ███████║╚██████╗██║  ██║███████╗██║ ╚═╝ ██║██║╚██████╔╝███████║
    ╚══════╝ ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝     ╚═╝╚═╝ ╚═════╝ ╚══════╝

      Welcome to Schemius!
        Press [Ctrl + H]        to show this welcome message
        Press [Ctrl + K]        to show essential keymap
        (environment-bindings)  -> Show bindings in current env
        (fact 2000)             -> If you'd like to see a big number :)

      Go through the code at https://github.com/cowuake/schemius
      `;

      const keymap = `
      Keymap:
        [arrow keys]            -> Move cursor | Navigate history
        [Shift + Enter]         -> Enter multiline insert mode
        [Ctrl + H]              -> Show help message
        [Ctrl + K]              -> Show keymap
        [Ctrl + Shift + F]      -> Switch font
      `

      setFont(defaultFont);

      init().then(() => {
        $("body").terminal(
          function (expression) {
            expression = expression.replace(/\r?\n|\r/g, " ").trim();
            if (expression) {
              try {
                this.echo(evaluate(expression));
              } catch (e) {
                console.log(e);
                this.echo("Ooops... Something went wrong! :(");
                this.read("Press [Enter] to reload\n\t").then(() => {
                  location.reload();
                });
              }
            }
          },
          {
            greetings: welcomeMessage,
            keydown: function (e) {
              if (e.ctrlKey) {
                e.preventDefault();
                switch (e.which) {
                  case 72: // Ctrl + H
                    this.echo(welcomeMessage);
                    return false;
                  case 75: // Ctrl + K
                    this.echo(keymap);
                    return false;
                }
                if (e.shiftKey) {
                  switch (e.which) {
                    case 70: // Ctrl + Shift + F
                      switchFont();
                      return false;
                  }
                }
              }
            },
            prompt: "λ> ",
          }
        );
      });
    </script>
  </body>
</html>
